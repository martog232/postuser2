import { Component, ViewChild, Input, Output, EventEmitter, ChangeDetectionStrategy } from '@angular/core';
import { Terminal } from 'xterm';
import { FitAddon } from 'xterm-addon-fit';
import { Subject } from 'rxjs';
import { ResizeObserver } from '@juggle/resize-observer';
import * as i0 from "@angular/core";
import * as i1 from "./global-style/global-style.component";
import * as i2 from "angular-resizable-element";
import * as i3 from "@angular/common";
export class NgTerminalComponent {
    constructor(renderer, ref, hostRef) {
        this.renderer = renderer;
        this.ref = ref;
        this.hostRef = hostRef;
        this.keyInputSubject = new Subject();
        this.keyEventSubject = new Subject();
        this.requestRenderFromAPI = new Subject();
        this.allLogsSubject = new Subject();
        this.resizableObservers = [];
        this.h = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
        this.paddingSize = 5;
        this.stylesForDiv = { 'display': 'block' };
        this._draggableInput = false;
        this._stylesInput = {};
        this.keyInputEmitter = new EventEmitter();
        this.keyEventEmitter = new EventEmitter();
        /**
         * @internal don't make a direct call
         */
        this.releaseNextOne = () => {
            if (!this.interval) {
                let list = this.waitingQueue.splice(0, 1);
                if (list.length == 1) {
                    this.allLogsSubject.next(list[0]);
                }
            }
        };
        /**
         * @internal don't make a direct call
         */
        this.waitingQueue = [];
        this.requestRenderSubscription = this.requestRenderFromAPI.subscribe(change => {
            let changeWithDefault = Object.assign({ rowChanged: false, columnChanged: false }, change);
            this.pushToWaitingQueue(changeWithDefault);
            this.getNextOrWait();
        });
    }
    set _dataSource(ds) {
        if (this.dataSourceSubscription != null) {
            this.dataSourceSubscription.unsubscribe();
        }
        this.dataSource = ds;
        this.dataSourceSubscription = this.dataSource.subscribe((data) => {
            this.write(data);
        });
    }
    get _dataSource() {
        return this.dataSource;
    }
    set draggable(draggable) {
        this._draggableInput = draggable;
        // this.applyStyleToDraggable();
    }
    get draggable() {
        return this._draggableInput;
    }
    setMinWidth(width) {
        this._minWidthInput = width;
    }
    setMinHeight(height) {
        this._minHeightInput = height;
    }
    setDraggable(draggable) {
        this._draggableInput = draggable;
        this.lastDraggedPosition = undefined;
        this.ref.markForCheck();
    }
    setRows(rows) {
        if (this._rowsInput != rows) {
            this._rowsInput = rows;
            this.requestRenderFromAPI.next({ rowChanged: true });
        }
    }
    setCols(cols) {
        if (this._colsInput != cols) {
            this._colsInput = cols;
            this.requestRenderFromAPI.next({ columnChanged: true });
        }
    }
    setStyle(styleObject) {
        var _a;
        if (JSON.stringify((_a = this._stylesInput) !== null && _a !== void 0 ? _a : {}) != JSON.stringify(styleObject !== null && styleObject !== void 0 ? styleObject : {})) {
            this._stylesInput = styleObject;
            this.requestRenderFromAPI.next({});
        }
    }
    getNextOrWait() {
        if (!this.hostRef.nativeElement.isConnected) {
            this.stopAndPolling();
        }
        else {
            this.releaseNextOne();
        }
    }
    pushToWaitingQueue(item) {
        this.waitingQueue.push(item);
        this.releaseNextOne();
    }
    /**
     * @internal
     */
    stopAndPolling() {
        const pollFunction = () => {
            if (this.interval)
                return;
            const interval = setInterval(() => {
                if (this.hostRef.nativeElement.isConnected) {
                    clearInterval(interval);
                    this.interval = undefined;
                    this.releaseNextOne();
                }
            }, 500);
            this.interval = interval;
        };
        pollFunction();
    }
    observableSetup() {
        this.term.onData((input) => {
            this.keyInputSubject.next(input);
        });
        this.term.onKey(e => {
            this.keyEventSubject.next(e);
        });
        this.keyInputSubjectSubscription = this.keyInputSubject.subscribe((data) => {
            this.keyInputEmitter.emit(data);
        });
        this.keyEventSubjectSubscription = this.keyEventSubject.subscribe((e) => {
            this.keyEventEmitter.emit(e);
        });
        this.resizableObservers = [this.observeTerminalDimension(), this.observeHostDimension()];
        this.allLogsSubjectSubscription = this.allLogsSubject.subscribe((change) => {
            if (change)
                this.coordinateOuterAndTerminal(change);
            else
                this.coordinateOuterAndTerminal(change);
            this.getNextOrWait();
        });
        this.getNextOrWait();
    }
    /**
     * set dimensions
     */
    setOuterDimensions(left, top, width, height) {
        this.requestRenderFromAPI.next({
            rowChanged: false, columnChanged: false,
            dragged: { draggedWidth: `${width}px`, draggedHeight: `${height}px` }
        });
    }
    /**
     * Render is being used for fast rendering without markForCheck().
     */
    applyStyleToDiv() {
        Object.keys(this.stylesForDiv).map(key => {
            return { key, value: this.stylesForDiv[key] };
        }).forEach(({ key, value }) => {
            if (value)
                this.renderer.setStyle(this.resizeBox.nativeElement, key, value);
            else {
                this.renderer.removeStyle(this.resizeBox.nativeElement, key);
            }
        });
        this.stylesForDiv = this.stylesForDiv; //invalidate
    }
    /**
     * When draggable is true, add border styles
     * Render is being used for fast rendering without markForCheck().
     */
    // private applyStyleToDraggable() {
    //   if (this._draggableInput)
    //     this.renderer.addClass(this.terminalOuter.nativeElement, 'draggable');
    //   else
    //     this.renderer.removeClass(this.terminalOuter.nativeElement, 'draggable');
    // }
    ngOnInit() {
    }
    /**
     * It creates new terminal in #terminal.
     */
    ngAfterViewInit() {
        this.fitAddon = new FitAddon();
        this.term = new Terminal();
        this.term.open(this.terminalOuter.nativeElement);
        this.term.loadAddon(this.fitAddon);
        this.observableSetup();
        this.requestRenderFromAPI.next({});
    }
    ngOnChanges(changes) {
        var _a, _b, _c, _d;
        console.group("onChanges");
        console.debug('prop: ', changes);
        console.groupEnd();
        if (changes === null || changes === void 0 ? void 0 : changes._rowsInput) {
            if (((_a = changes === null || changes === void 0 ? void 0 : changes._rowsInput) === null || _a === void 0 ? void 0 : _a.previousValue) != ((_b = changes === null || changes === void 0 ? void 0 : changes._rowsInput) === null || _b === void 0 ? void 0 : _b.currentValue)) {
                this.requestRenderFromAPI.next({ rowChanged: true });
            }
        }
        if (changes === null || changes === void 0 ? void 0 : changes._colsInput) {
            if (((_c = changes === null || changes === void 0 ? void 0 : changes._colsInput) === null || _c === void 0 ? void 0 : _c.previousValue) != ((_d = changes === null || changes === void 0 ? void 0 : changes._colsInput) === null || _d === void 0 ? void 0 : _d.currentValue)) {
                this.requestRenderFromAPI.next({ columnChanged: true });
            }
        }
        // this.requestRenderFromAPI.next({});
    }
    /**
     * It must be called after having initialized the terminal.
     * xterm fit
     * @param rowColChange
     * @returns
     */
    coordinateOuterAndTerminal(changeList) {
        var _a, _b;
        console.debug(`changeList: ${JSON.stringify(changeList)}`);
        // apply a style input while keeping width and height default
        this.stylesForDiv = Object.assign(Object.assign(Object.assign({}, this.stylesForDiv), this._stylesInput), { width: this.stylesForDiv.width, height: this.stylesForDiv.height });
        // but if the div is dragged, update width, height
        if (changeList.dragged) {
            this.stylesForDiv.width = changeList.dragged.draggedWidth;
            this.stylesForDiv.height = changeList.dragged.draggedHeight;
            this.lastDraggedPosition = { width: changeList.dragged.draggedWidth, height: changeList.dragged.draggedHeight };
        }
        else if (!this._rowsInput && !this._colsInput && !(this.draggable && this.lastDraggedPosition)) {
            // but if the dimension of host element is resized, update width and height
            this.stylesForDiv.width = '100%';
            this.stylesForDiv.height = '100%';
        }
        this.applyStyleToDiv();
        // resize with new cols and rows if they changed.
        if (changeList.rowChanged || changeList.columnChanged) {
            this.term.resize((_a = this._colsInput) !== null && _a !== void 0 ? _a : this.term.cols, (_b = this._rowsInput) !== null && _b !== void 0 ? _b : this.term.rows);
        }
        else {
            // fit() operation doesn't see padding values of terminalOuter.
            // But it uses padding values of terminal element.
            // So we force to set padding values when calling fit() operation for a while.
            this.term.element.style.paddingLeft = `${this.paddingSize}px`;
            this.term.element.style.paddingRight = `${this.paddingSize}px`;
            this.fitAddon.fit();
            this.term.element.style.padding = '0px';
        }
        // coordinate difference between terminal and outer
        let xtermScreen = this.term.element.getElementsByClassName('xterm-screen')[0];
        let xtermViewport = this.term.element.getElementsByClassName('xterm-viewport')[0];
        const terminalWidth = xtermScreen.clientWidth;
        const terminalHeight = xtermScreen.clientHeight;
        const core = this.underlying._core;
        const scrollWidth = core.viewport.scrollBarWidth;
        // It fixes that the viewport's width doesn't changes after calling fit()
        this.renderer.setStyle(xtermViewport, 'width', `${terminalWidth + scrollWidth}px`);
        console.debug(terminalWidth + scrollWidth + this.paddingSize * 2, terminalWidth, scrollWidth, this.paddingSize * 2); // + borderWidth * 2
        console.debug(terminalHeight + this.paddingSize * 2, terminalHeight);
        this.stylesForDiv = Object.assign(Object.assign({}, this.stylesForDiv), { width: `${terminalWidth + scrollWidth + this.paddingSize * 2}px`, height: `${terminalHeight + this.paddingSize * 2}px` });
        this.applyStyleToDiv();
        this.ref.markForCheck();
    }
    observeTerminalDimension() {
        let viewport = this.terminalOuter.nativeElement.querySelector('.xterm-viewport');
        if (viewport) {
            const resizeObserver = new ResizeObserver(entries => {
                const divWidth = parseFloat(getComputedStyle(this.terminalOuter.nativeElement).width);
                const divHeight = parseFloat(getComputedStyle(this.terminalOuter.nativeElement).height);
                let width = undefined;
                let height = undefined;
                for (let entry of entries) {
                    if (entry.contentBoxSize) {
                        if (entry.target instanceof HTMLElement) {
                            width = parseFloat(getComputedStyle(entry.target).width);
                            height = parseFloat(getComputedStyle(entry.target).height);
                        }
                    }
                    else {
                        width = parseFloat(getComputedStyle(entry.target).width);
                        height = parseFloat(getComputedStyle(entry.target).height);
                    }
                }
                if (width > divWidth || height > divHeight) {
                    this.requestRenderFromAPI.next({ whenTerminalDimensionIsOverOuterDiv: { width: `${width}px`, height: `${height}px` } });
                }
            });
            resizeObserver.observe(viewport);
            return resizeObserver;
        }
        else {
            console.error("Invalid state is detected. xterm element should exist below .terminal-outer.");
        }
    }
    observeHostDimension() {
        let hostElement = this.hostRef.nativeElement;
        if (hostElement) {
            const resizeObserver = new ResizeObserver(entries => {
                let width = undefined;
                let height = undefined;
                for (let entry of entries) {
                    if (entry.contentBoxSize) {
                        if (entry.target instanceof HTMLElement) {
                            width = parseFloat(getComputedStyle(entry.target).width);
                            height = parseFloat(getComputedStyle(entry.target).height);
                        }
                    }
                    else {
                        width = parseFloat(getComputedStyle(entry.target).width);
                        height = parseFloat(getComputedStyle(entry.target).height);
                    }
                }
                this.requestRenderFromAPI.next({ hostResized: { width: `${width}px`, height: `${height}px` } });
            });
            resizeObserver.observe(hostElement);
            return resizeObserver;
        }
        else {
            console.error("Invalid state is detected. xterm element should exist below .terminal-outer.");
        }
    }
    /**
     * clean all resources
     */
    ngOnDestroy() {
        if (this.keyInputSubjectSubscription)
            this.keyInputSubjectSubscription.unsubscribe();
        if (this.dataSourceSubscription)
            this.dataSourceSubscription.unsubscribe();
        if (this.keyEventSubjectSubscription)
            this.keyEventSubjectSubscription.unsubscribe();
        if (this.requestRenderSubscription)
            this.requestRenderSubscription.unsubscribe();
        if (this.allLogsSubjectSubscription)
            this.allLogsSubjectSubscription.unsubscribe();
        if (this.interval)
            clearInterval(this.interval);
        if (this.term)
            this.term.dispose();
        this.resizableObservers.forEach(ob => ob.disconnect());
    }
    write(chars) {
        this.term.write(chars);
    }
    get keyInput() {
        return this.keyInputSubject;
    }
    get keyEventInput() {
        return this.keyEventSubject;
    }
    get underlying() {
        return this.term;
    }
    get isDraggableOnEdgeActivated() {
        // return this.displayOption.activateDraggableOnEdge != undefined && this.displayOption.fixedGrid == undefined;
        return this._draggableInput;
    }
    /**
     * After user coordinate dimensions of terminal, it's called.
     * @param left
     * @param top
     * @param width
     * @param height
     */
    onResizeEnd(left, top, width, height) {
        this.setOuterDimensions(left, top, width, height);
    }
    /**
     * Before onResizeEnd is called, it valiates dimensions to change.
     * @param re dimension to be submitted from resizable stuff
     */
    validatorFactory() {
        const comp = this;
        return (re) => {
            var _a, _b;
            // const displayOption = comp.displayOption;
            if (this._draggableInput) {
                let left = re.rectangle.left, top = re.rectangle.top, width = re.rectangle.width, height = re.rectangle.height;
                if ((width < ((_a = this._minWidthInput) !== null && _a !== void 0 ? _a : 100)) || (height < ((_b = this._minHeightInput) !== null && _b !== void 0 ? _b : 50))) {
                    return false;
                }
                else
                    return true;
            }
            else
                return false;
        };
    }
}
NgTerminalComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: NgTerminalComponent, deps: [{ token: i0.Renderer2 }, { token: i0.ChangeDetectorRef }, { token: i0.ElementRef }], target: i0.ɵɵFactoryTarget.Component });
NgTerminalComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "12.2.16", type: NgTerminalComponent, selector: "ng-terminal", inputs: { _dataSource: ["dataSource", "_dataSource"], _rowsInput: ["rows", "_rowsInput"], _colsInput: ["cols", "_colsInput"], _minWidthInput: ["minWidth", "_minWidthInput"], _minHeightInput: ["minHeight", "_minHeightInput"], draggable: "draggable" }, outputs: { keyInputEmitter: "keyInput", keyEventEmitter: "keyEvent" }, viewQueries: [{ propertyName: "terminalOuter", first: true, predicate: ["terminal"], descendants: true, static: true }, { propertyName: "resizeBox", first: true, predicate: ["resizeBox"], descendants: true, static: true }], usesOnChanges: true, ngImport: i0, template: "<global-style></global-style>\n<div mwlResizable #resizeBox class=\"resize-box\" [validateResize]=\"validatorFactory()\" [enableGhostResize]=\"true\"\n    (resizeEnd)=\"onResizeEnd($event.rectangle.left, $event.rectangle.top, $event.rectangle.width, $event.rectangle.height)\">\n    <div #terminal class=\"terminal-outer\">\n    </div>\n    <div class=\"resize-handle resize-handle-top\" mwlResizeHandle [ngClass]=\"{'handle-active' : isDraggableOnEdgeActivated}\"\n        [resizeEdges]=\"{ top: false }\"></div>\n    <div class=\"resize-handle resize-handle-left\" mwlResizeHandle [ngClass]=\"{'handle-active' : isDraggableOnEdgeActivated}\"\n        [resizeEdges]=\"{ left: false }\"></div>\n    <div class=\"resize-handle resize-handle-right\" mwlResizeHandle [ngClass]=\"{'handle-active' : isDraggableOnEdgeActivated}\"\n        [resizeEdges]=\"isDraggableOnEdgeActivated ? { right: true } : { right: false }\"></div>\n    <div class=\"resize-handle resize-handle-bottom\" mwlResizeHandle [ngClass]=\"{'handle-active' : isDraggableOnEdgeActivated}\"\n        [resizeEdges]=\"isDraggableOnEdgeActivated ? { bottom: true } : { bottom: false }\"></div>\n</div>", styles: [".terminal-outer{box-sizing:border-box;height:100%;width:100%;padding:5px}:host{display:block;height:100%;width:100%}.resize-box{height:100%;width:100%;position:relative}div>.handle-active{z-index:100;background-color:#85858a}.resize-handle{background-color:#000}.resize-handle-top.handle-active,.resize-handle-bottom.handle-active{cursor:row-resize}.resize-handle-left.handle-active,.resize-handle-right.handle-active{cursor:col-resize}.resize-handle-top,.resize-handle-bottom{position:absolute;height:5px;width:100%}.resize-handle-top{top:0px}.resize-handle-bottom{bottom:0px}.resize-handle-left,.resize-handle-right{position:absolute;height:calc(100%);width:5px}.resize-handle-left{left:0px;top:0px}.resize-handle-right{right:0px;top:0px}\n"], components: [{ type: i1.GlobalStyleComponent, selector: "global-style" }], directives: [{ type: i2.ResizableDirective, selector: "[mwlResizable]", inputs: ["validateResize", "enableGhostResize", "resizeSnapGrid", "resizeCursors", "ghostElementPositioning", "allowNegativeResizes", "mouseMoveThrottleMS"], outputs: ["resizeStart", "resizing", "resizeEnd"], exportAs: ["mwlResizable"] }, { type: i2.ResizeHandleDirective, selector: "[mwlResizeHandle]", inputs: ["resizeEdges", "resizableContainer"] }, { type: i3.NgClass, selector: "[ngClass]", inputs: ["class", "ngClass"] }], changeDetection: i0.ChangeDetectionStrategy.OnPush });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: NgTerminalComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'ng-terminal',
                    templateUrl: './ng-terminal.component.html',
                    styleUrls: ['./ng-terminal.component.css'],
                    changeDetection: ChangeDetectionStrategy.OnPush
                }]
        }], ctorParameters: function () { return [{ type: i0.Renderer2 }, { type: i0.ChangeDetectorRef }, { type: i0.ElementRef }]; }, propDecorators: { _dataSource: [{
                type: Input,
                args: ['dataSource']
            }], _rowsInput: [{
                type: Input,
                args: ['rows']
            }], _colsInput: [{
                type: Input,
                args: ['cols']
            }], _minWidthInput: [{
                type: Input,
                args: ['minWidth']
            }], _minHeightInput: [{
                type: Input,
                args: ['minHeight']
            }], draggable: [{
                type: Input,
                args: ['draggable']
            }], keyInputEmitter: [{
                type: Output,
                args: ['keyInput']
            }], keyEventEmitter: [{
                type: Output,
                args: ['keyEvent']
            }], terminalOuter: [{
                type: ViewChild,
                args: ['terminal', { static: true }]
            }], resizeBox: [{
                type: ViewChild,
                args: ['resizeBox', { static: true }]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctdGVybWluYWwuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvbmctdGVybWluYWwvc3JjL2xpYi9uZy10ZXJtaW5hbC5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi9wcm9qZWN0cy9uZy10ZXJtaW5hbC9zcmMvbGliL25nLXRlcm1pbmFsLmNvbXBvbmVudC5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQTRCLFNBQVMsRUFBYyxLQUFLLEVBQUUsTUFBTSxFQUFFLFlBQVksRUFBNEIsdUJBQXVCLEVBQTBELE1BQU0sZUFBZSxDQUFDO0FBQ25PLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxPQUFPLENBQUM7QUFDakMsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRTNDLE9BQU8sRUFBRSxPQUFPLEVBQW1GLE1BQU0sTUFBTSxDQUFDO0FBR2hILE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQzs7Ozs7QUFTekQsTUFBTSxPQUFPLG1CQUFtQjtJQW9MOUIsWUFBb0IsUUFBbUIsRUFBVSxHQUFzQixFQUFVLE9BQW1CO1FBQWhGLGFBQVEsR0FBUixRQUFRLENBQVc7UUFBVSxRQUFHLEdBQUgsR0FBRyxDQUFtQjtRQUFVLFlBQU8sR0FBUCxPQUFPLENBQVk7UUFqTDVGLG9CQUFlLEdBQW9CLElBQUksT0FBTyxFQUFVLENBQUM7UUFDekQsb0JBQWUsR0FBRyxJQUFJLE9BQU8sRUFBNkMsQ0FBQztRQUMzRSx5QkFBb0IsR0FBRyxJQUFJLE9BQU8sRUFLdEMsQ0FBQztRQUNHLG1CQUFjLEdBQUcsSUFBSSxPQUFPLEVBTWhDLENBQUM7UUFPRyx1QkFBa0IsR0FBcUIsRUFBRSxDQUFDO1FBQzFDLE1BQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxlQUFlLENBQUMsWUFBWSxFQUFFLE1BQU0sQ0FB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QUMsTUFBQSxJQUFJLENBQUMsY0FBYyxtQ0FBSSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsTUFBQSxJQUFJLENBQUMsZUFBZSxtQ0FBSSxFQUFFLENBQUMsQ0FBQyxFQUFFO29CQUNyRixPQUFPLEtBQUssQ0FBQztpQkFDZDs7b0JBQU0sT0FBTyxJQUFJLENBQUM7YUFDcEI7O2dCQUNDLE9BQU8sS0FBSyxDQUFDO1FBQ2pCLENBQUMsQ0FBQTtJQUNILENBQUM7O2lIQXZkVSxtQkFBbUI7cUdBQW5CLG1CQUFtQiwwbUJDaEJoQyw0b0NBYU07NEZER08sbUJBQW1CO2tCQU4vQixTQUFTO21CQUFDO29CQUNULFFBQVEsRUFBRSxhQUFhO29CQUN2QixXQUFXLEVBQUUsOEJBQThCO29CQUMzQyxTQUFTLEVBQUUsQ0FBQyw2QkFBNkIsQ0FBQztvQkFDMUMsZUFBZSxFQUFFLHVCQUF1QixDQUFDLE1BQU07aUJBQ2hEO3lKQWtDSyxXQUFXO3NCQURkLEtBQUs7dUJBQUMsWUFBWTtnQkFlbkIsVUFBVTtzQkFEVCxLQUFLO3VCQUFDLE1BQU07Z0JBR2IsVUFBVTtzQkFEVCxLQUFLO3VCQUFDLE1BQU07Z0JBR2IsY0FBYztzQkFEYixLQUFLO3VCQUFDLFVBQVU7Z0JBR2pCLGVBQWU7c0JBRGQsS0FBSzt1QkFBQyxXQUFXO2dCQUdkLFNBQVM7c0JBRFosS0FBSzt1QkFBQyxXQUFXO2dCQWtEbEIsZUFBZTtzQkFEZCxNQUFNO3VCQUFDLFVBQVU7Z0JBSWxCLGVBQWU7c0JBRGQsTUFBTTt1QkFBQyxVQUFVO2dCQUlsQixhQUFhO3NCQURaLFNBQVM7dUJBQUMsVUFBVSxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRTtnQkFJdkMsU0FBUztzQkFEUixTQUFTO3VCQUFDLFdBQVcsRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIE9uSW5pdCwgQWZ0ZXJWaWV3Q2hlY2tlZCwgVmlld0NoaWxkLCBFbGVtZW50UmVmLCBJbnB1dCwgT3V0cHV0LCBFdmVudEVtaXR0ZXIsIE9uRGVzdHJveSwgQWZ0ZXJWaWV3SW5pdCwgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksIENoYW5nZURldGVjdG9yUmVmLCBPbkNoYW5nZXMsIFJlbmRlcmVyMiwgU2ltcGxlQ2hhbmdlcyB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgVGVybWluYWwgfSBmcm9tICd4dGVybSc7XG5pbXBvcnQgeyBGaXRBZGRvbiB9IGZyb20gJ3h0ZXJtLWFkZG9uLWZpdCc7XG5pbXBvcnQgeyBOZ1Rlcm1pbmFsIH0gZnJvbSAnLi9uZy10ZXJtaW5hbCc7XG5pbXBvcnQgeyBTdWJqZWN0LCBPYnNlcnZhYmxlLCBTdWJzY3JpcHRpb24sIGNvbWJpbmVMYXRlc3QsIE9iamVjdFVuc3Vic2NyaWJlZEVycm9yLCBSZXBsYXlTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBSZXNpemVFdmVudCB9IGZyb20gJ2FuZ3VsYXItcmVzaXphYmxlLWVsZW1lbnQnO1xuaW1wb3J0IHsgUmVzaXplT2JzZXJ2ZXIgfSBmcm9tICdAanVnZ2xlL3Jlc2l6ZS1vYnNlcnZlcic7XG5cblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnbmctdGVybWluYWwnLFxuICB0ZW1wbGF0ZVVybDogJy4vbmctdGVybWluYWwuY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi9uZy10ZXJtaW5hbC5jb21wb25lbnQuY3NzJ10sXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoXG59KVxuZXhwb3J0IGNsYXNzIE5nVGVybWluYWxDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcywgQWZ0ZXJWaWV3SW5pdCwgTmdUZXJtaW5hbCwgT25EZXN0cm95IHtcbiAgcHJpdmF0ZSB0ZXJtOiBUZXJtaW5hbDtcbiAgcHJpdmF0ZSBmaXRBZGRvbjogRml0QWRkb247XG4gIHByaXZhdGUga2V5SW5wdXRTdWJqZWN0OiBTdWJqZWN0PHN0cmluZz4gPSBuZXcgU3ViamVjdDxzdHJpbmc+KCk7XG4gIHByaXZhdGUga2V5RXZlbnRTdWJqZWN0ID0gbmV3IFN1YmplY3Q8eyBrZXk6IHN0cmluZzsgZG9tRXZlbnQ6IEtleWJvYXJkRXZlbnQ7IH0+KCk7XG4gIHByaXZhdGUgcmVxdWVzdFJlbmRlckZyb21BUEkgPSBuZXcgU3ViamVjdDx7XG4gICAgcm93Q2hhbmdlZD86IGJvb2xlYW4sIGNvbHVtbkNoYW5nZWQ/OiBib29sZWFuXG4gICAgLCBkcmFnZ2VkPzogeyBkcmFnZ2VkV2lkdGg6IHN0cmluZywgZHJhZ2dlZEhlaWdodDogc3RyaW5nIH1cbiAgICAsIGhvc3RSZXNpemVkPzogeyB3aWR0aDogc3RyaW5nLCBoZWlnaHQ6IHN0cmluZyB9XG4gICAgLCB3aGVuVGVybWluYWxEaW1lbnNpb25Jc092ZXJPdXRlckRpdj86IHsgd2lkdGg6IHN0cmluZywgaGVpZ2h0OiBzdHJpbmcgfVxuICB9PigpO1xuICBwcml2YXRlIGFsbExvZ3NTdWJqZWN0ID0gbmV3IFN1YmplY3Q8e1xuICAgIHJvd0NoYW5nZWQ6IGJvb2xlYW5cbiAgICAsIGNvbHVtbkNoYW5nZWQ6IGJvb2xlYW5cbiAgICAsIGRyYWdnZWQ/OiB7IGRyYWdnZWRXaWR0aDogc3RyaW5nLCBkcmFnZ2VkSGVpZ2h0OiBzdHJpbmcgfVxuICAgICwgaG9zdFJlc2l6ZWQ/OiB7IHdpZHRoOiBzdHJpbmcsIGhlaWdodDogc3RyaW5nIH1cbiAgICAsIHdoZW5UZXJtaW5hbERpbWVuc2lvbklzT3Zlck91dGVyRGl2PzogeyB3aWR0aDogc3RyaW5nLCBoZWlnaHQ6IHN0cmluZyB9XG4gIH0+KCk7XG4gIC8vIHByaXZhdGUgYWZ0ZXJWaWV3SW5pdFN1YmplY3QgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xuXG4gIHByaXZhdGUga2V5SW5wdXRTdWJqZWN0U3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG4gIHByaXZhdGUga2V5RXZlbnRTdWJqZWN0U3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG4gIHByaXZhdGUgYWxsTG9nc1N1YmplY3RTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcbiAgcHJpdmF0ZSByZXF1ZXN0UmVuZGVyU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG4gIHByaXZhdGUgcmVzaXphYmxlT2JzZXJ2ZXJzOiBSZXNpemVPYnNlcnZlcltdID0gW107XG4gIHByaXZhdGUgaCA9IE1hdGgubWF4KGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRIZWlnaHQsIHdpbmRvdy5pbm5lckhlaWdodCB8fCAwKTtcbiAgLy8gcHJpdmF0ZSBkaXNwbGF5T3B0aW9uOiBEaXNwbGF5T3B0aW9uID0ge307XG4gIHByaXZhdGUgZGF0YVNvdXJjZTogT2JzZXJ2YWJsZTxzdHJpbmc+O1xuICBwcml2YXRlIGRhdGFTb3VyY2VTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcbiAgcHJpdmF0ZSByZWFkb25seSBwYWRkaW5nU2l6ZSA9IDU7XG4gIHN0eWxlc0ZvckRpdjogUGFydGlhbDxDU1NTdHlsZURlY2xhcmF0aW9uPiA9IHsgJ2Rpc3BsYXknOiAnYmxvY2snIH07XG5cbiAgQElucHV0KCdkYXRhU291cmNlJylcbiAgc2V0IF9kYXRhU291cmNlKGRzKSB7XG4gICAgaWYgKHRoaXMuZGF0YVNvdXJjZVN1YnNjcmlwdGlvbiAhPSBudWxsKSB7XG4gICAgICB0aGlzLmRhdGFTb3VyY2VTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICB9XG4gICAgdGhpcy5kYXRhU291cmNlID0gZHM7XG4gICAgdGhpcy5kYXRhU291cmNlU3Vic2NyaXB0aW9uID0gdGhpcy5kYXRhU291cmNlLnN1YnNjcmliZSgoZGF0YSkgPT4ge1xuICAgICAgdGhpcy53cml0ZShkYXRhKTtcbiAgICB9KVxuICB9XG4gIGdldCBfZGF0YVNvdXJjZSgpIHtcbiAgICByZXR1cm4gdGhpcy5kYXRhU291cmNlO1xuICB9XG5cbiAgQElucHV0KCdyb3dzJylcbiAgX3Jvd3NJbnB1dD86IG51bWJlcjtcbiAgQElucHV0KCdjb2xzJylcbiAgX2NvbHNJbnB1dD86IG51bWJlcjtcbiAgQElucHV0KCdtaW5XaWR0aCcpXG4gIF9taW5XaWR0aElucHV0PzogbnVtYmVyO1xuICBASW5wdXQoJ21pbkhlaWdodCcpXG4gIF9taW5IZWlnaHRJbnB1dD86IG51bWJlcjtcbiAgQElucHV0KCdkcmFnZ2FibGUnKVxuICBzZXQgZHJhZ2dhYmxlKGRyYWdnYWJsZTogYm9vbGVhbikge1xuICAgIHRoaXMuX2RyYWdnYWJsZUlucHV0ID0gZHJhZ2dhYmxlO1xuICAgIC8vIHRoaXMuYXBwbHlTdHlsZVRvRHJhZ2dhYmxlKCk7XG4gIH1cbiAgZ2V0IGRyYWdnYWJsZSgpe1xuICAgIHJldHVybiB0aGlzLl9kcmFnZ2FibGVJbnB1dDtcbiAgfVxuICBsYXN0RHJhZ2dlZFBvc2l0aW9uOnt3aWR0aDogc3RyaW5nLCBoZWlnaHQ6IHN0cmluZ307XG5cbiAgX2RyYWdnYWJsZUlucHV0PzogYm9vbGVhbiA9IGZhbHNlO1xuXG4gIF9zdHlsZXNJbnB1dDogYW55ID0ge307XG5cbiAgc2V0TWluV2lkdGgod2lkdGg6IG51bWJlcik6IHZvaWQge1xuICAgIHRoaXMuX21pbldpZHRoSW5wdXQgPSB3aWR0aDtcbiAgfVxuICBzZXRNaW5IZWlnaHQoaGVpZ2h0OiBudW1iZXIpOiB2b2lkIHtcbiAgICB0aGlzLl9taW5IZWlnaHRJbnB1dCA9IGhlaWdodDtcbiAgfVxuXG4gIHNldERyYWdnYWJsZShkcmFnZ2FibGU6IGJvb2xlYW4pOiB2b2lkIHtcbiAgICB0aGlzLl9kcmFnZ2FibGVJbnB1dCA9IGRyYWdnYWJsZTtcbiAgICB0aGlzLmxhc3REcmFnZ2VkUG9zaXRpb24gPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5yZWYubWFya0ZvckNoZWNrKCk7XG4gIH1cblxuICBzZXRSb3dzKHJvd3M6IG51bWJlcik6IHZvaWQge1xuICAgIGlmICh0aGlzLl9yb3dzSW5wdXQgIT0gcm93cyl7XG4gICAgICB0aGlzLl9yb3dzSW5wdXQgPSByb3dzO1xuICAgICAgdGhpcy5yZXF1ZXN0UmVuZGVyRnJvbUFQSS5uZXh0KHsgcm93Q2hhbmdlZDogdHJ1ZSB9KTtcbiAgICB9XG4gIH1cblxuICBzZXRDb2xzKGNvbHM6IG51bWJlcik6IHZvaWQge1xuICAgIGlmICh0aGlzLl9jb2xzSW5wdXQgIT0gY29scyl7XG4gICAgICB0aGlzLl9jb2xzSW5wdXQgPSBjb2xzO1xuICAgICAgdGhpcy5yZXF1ZXN0UmVuZGVyRnJvbUFQSS5uZXh0KHsgY29sdW1uQ2hhbmdlZDogdHJ1ZSB9KTtcbiAgICB9XG4gIH1cblxuICBzZXRTdHlsZShzdHlsZU9iamVjdDogYW55KTogdm9pZCB7XG4gICAgaWYgKEpTT04uc3RyaW5naWZ5KHRoaXMuX3N0eWxlc0lucHV0ID8/IHt9KSAhPSBKU09OLnN0cmluZ2lmeShzdHlsZU9iamVjdCA/PyB7fSkpe1xuICAgICAgdGhpcy5fc3R5bGVzSW5wdXQgPSBzdHlsZU9iamVjdDtcbiAgICAgIHRoaXMucmVxdWVzdFJlbmRlckZyb21BUEkubmV4dCh7fSk7XG4gICAgfVxuICAgIFxuICB9XG5cbiAgQE91dHB1dCgna2V5SW5wdXQnKVxuICBrZXlJbnB1dEVtaXR0ZXIgPSBuZXcgRXZlbnRFbWl0dGVyPHN0cmluZz4oKTtcblxuICBAT3V0cHV0KCdrZXlFdmVudCcpXG4gIGtleUV2ZW50RW1pdHRlciA9IG5ldyBFdmVudEVtaXR0ZXI8eyBrZXk6IHN0cmluZzsgZG9tRXZlbnQ6IEtleWJvYXJkRXZlbnQ7IH0+KCk7XG5cbiAgQFZpZXdDaGlsZCgndGVybWluYWwnLCB7IHN0YXRpYzogdHJ1ZSB9KVxuICB0ZXJtaW5hbE91dGVyOiBFbGVtZW50UmVmO1xuXG4gIEBWaWV3Q2hpbGQoJ3Jlc2l6ZUJveCcsIHsgc3RhdGljOiB0cnVlIH0pXG4gIHJlc2l6ZUJveDogRWxlbWVudFJlZjtcblxuICBwcml2YXRlIGdldE5leHRPcldhaXQoKSB7XG4gICAgaWYgKCF0aGlzLmhvc3RSZWYubmF0aXZlRWxlbWVudC5pc0Nvbm5lY3RlZCkge1xuICAgICAgdGhpcy5zdG9wQW5kUG9sbGluZygpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnJlbGVhc2VOZXh0T25lKCk7XG4gICAgfVxuICB9XG4gIHByaXZhdGUgcHVzaFRvV2FpdGluZ1F1ZXVlKGl0ZW06IHtcbiAgICByb3dDaGFuZ2VkOiBib29sZWFuXG4gICAgLCBjb2x1bW5DaGFuZ2VkOiBib29sZWFuXG4gICAgLCBkcmFnZ2VkPzogeyBkcmFnZ2VkV2lkdGg6IHN0cmluZywgZHJhZ2dlZEhlaWdodDogc3RyaW5nIH1cbiAgICAsIGhvc3RSZXNpemVkPzogeyB3aWR0aDogc3RyaW5nLCBoZWlnaHQ6IHN0cmluZyB9XG4gICAgLCB3aGVuVGVybWluYWxEaW1lbnNpb25Jc092ZXJPdXRlckRpdj86IHsgd2lkdGg6IHN0cmluZywgaGVpZ2h0OiBzdHJpbmcgfVxuICB9KSB7XG4gICAgdGhpcy53YWl0aW5nUXVldWUucHVzaChpdGVtKTtcbiAgICB0aGlzLnJlbGVhc2VOZXh0T25lKCk7XG4gIH1cblxuICAvKipcbiAgICogQGludGVybmFsXG4gICAqL1xuICBwcml2YXRlIHN0b3BBbmRQb2xsaW5nKCkge1xuICAgIGNvbnN0IHBvbGxGdW5jdGlvbiA9ICgpID0+IHtcbiAgICAgIGlmICh0aGlzLmludGVydmFsKVxuICAgICAgICByZXR1cm47XG4gICAgICBjb25zdCBpbnRlcnZhbCA9IHNldEludGVydmFsKCgpID0+IHtcbiAgICAgICAgaWYgKHRoaXMuaG9zdFJlZi5uYXRpdmVFbGVtZW50LmlzQ29ubmVjdGVkKSB7XG4gICAgICAgICAgY2xlYXJJbnRlcnZhbChpbnRlcnZhbCk7XG4gICAgICAgICAgdGhpcy5pbnRlcnZhbCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICB0aGlzLnJlbGVhc2VOZXh0T25lKCk7XG4gICAgICAgIH1cbiAgICAgIH0sIDUwMCk7XG4gICAgICB0aGlzLmludGVydmFsID0gaW50ZXJ2YWw7XG4gICAgfVxuICAgIHBvbGxGdW5jdGlvbigpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBpbnRlcm5hbCBkb24ndCBtYWtlIGEgZGlyZWN0IGNhbGxcbiAgICovXG4gIGludGVydmFsOiBSZXR1cm5UeXBlPHR5cGVvZiBzZXRJbnRlcnZhbD47XG5cbiAgLyoqXG4gICAqIEBpbnRlcm5hbCBkb24ndCBtYWtlIGEgZGlyZWN0IGNhbGxcbiAgICovXG4gIHByaXZhdGUgcmVsZWFzZU5leHRPbmUgPSAoKSA9PiB7XG4gICAgaWYgKCF0aGlzLmludGVydmFsKSB7XG4gICAgICBsZXQgbGlzdCA9IHRoaXMud2FpdGluZ1F1ZXVlLnNwbGljZSgwLCAxKTtcbiAgICAgIGlmIChsaXN0Lmxlbmd0aCA9PSAxKSB7XG4gICAgICAgIHRoaXMuYWxsTG9nc1N1YmplY3QubmV4dChsaXN0WzBdKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQGludGVybmFsIGRvbid0IG1ha2UgYSBkaXJlY3QgY2FsbFxuICAgKi9cbiAgcHJpdmF0ZSB3YWl0aW5nUXVldWU6IHtcbiAgICByb3dDaGFuZ2VkOiBib29sZWFuXG4gICAgLCBjb2x1bW5DaGFuZ2VkOiBib29sZWFuXG4gICAgLCBkcmFnZ2VkPzogeyBkcmFnZ2VkV2lkdGg6IHN0cmluZywgZHJhZ2dlZEhlaWdodDogc3RyaW5nIH1cbiAgICAsIGhvc3RSZXNpemVkPzogeyB3aWR0aDogc3RyaW5nLCBoZWlnaHQ6IHN0cmluZyB9XG4gICAgLCB3aGVuVGVybWluYWxEaW1lbnNpb25Jc092ZXJPdXRlckRpdj86IHsgd2lkdGg6IHN0cmluZywgaGVpZ2h0OiBzdHJpbmcgfVxuICB9W10gPSBbXTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlbmRlcmVyOiBSZW5kZXJlcjIsIHByaXZhdGUgcmVmOiBDaGFuZ2VEZXRlY3RvclJlZiwgcHJpdmF0ZSBob3N0UmVmOiBFbGVtZW50UmVmKSB7XG4gICAgdGhpcy5yZXF1ZXN0UmVuZGVyU3Vic2NyaXB0aW9uID0gdGhpcy5yZXF1ZXN0UmVuZGVyRnJvbUFQSS5zdWJzY3JpYmUoY2hhbmdlID0+IHtcbiAgICAgIGxldCBjaGFuZ2VXaXRoRGVmYXVsdCA9IHtcbiAgICAgICAgcm93Q2hhbmdlZDogZmFsc2UsIGNvbHVtbkNoYW5nZWQ6IGZhbHNlLCAuLi5jaGFuZ2VcbiAgICAgIH07XG4gICAgICB0aGlzLnB1c2hUb1dhaXRpbmdRdWV1ZShjaGFuZ2VXaXRoRGVmYXVsdCk7XG4gICAgICB0aGlzLmdldE5leHRPcldhaXQoKTtcbiAgICB9KTtcbiAgfVxuICBwcml2YXRlIG9ic2VydmFibGVTZXR1cCgpIHtcbiAgICB0aGlzLnRlcm0ub25EYXRhKChpbnB1dCkgPT4ge1xuICAgICAgdGhpcy5rZXlJbnB1dFN1YmplY3QubmV4dChpbnB1dCk7XG4gICAgfSk7XG4gICAgdGhpcy50ZXJtLm9uS2V5KGUgPT4ge1xuICAgICAgdGhpcy5rZXlFdmVudFN1YmplY3QubmV4dChlKTtcbiAgICB9KVxuICAgIHRoaXMua2V5SW5wdXRTdWJqZWN0U3Vic2NyaXB0aW9uID0gdGhpcy5rZXlJbnB1dFN1YmplY3Quc3Vic2NyaWJlKChkYXRhKSA9PiB7XG4gICAgICB0aGlzLmtleUlucHV0RW1pdHRlci5lbWl0KGRhdGEpO1xuICAgIH0pXG4gICAgdGhpcy5rZXlFdmVudFN1YmplY3RTdWJzY3JpcHRpb24gPSB0aGlzLmtleUV2ZW50U3ViamVjdC5zdWJzY3JpYmUoKGUpID0+IHtcbiAgICAgIHRoaXMua2V5RXZlbnRFbWl0dGVyLmVtaXQoZSk7XG4gICAgfSk7XG5cbiAgICB0aGlzLnJlc2l6YWJsZU9ic2VydmVycyA9IFt0aGlzLm9ic2VydmVUZXJtaW5hbERpbWVuc2lvbigpLCB0aGlzLm9ic2VydmVIb3N0RGltZW5zaW9uKCldO1xuICAgIHRoaXMuYWxsTG9nc1N1YmplY3RTdWJzY3JpcHRpb24gPSB0aGlzLmFsbExvZ3NTdWJqZWN0LnN1YnNjcmliZSgoY2hhbmdlKSA9PiB7XG4gICAgICBpZiAoY2hhbmdlKVxuICAgICAgICB0aGlzLmNvb3JkaW5hdGVPdXRlckFuZFRlcm1pbmFsKGNoYW5nZSk7XG4gICAgICBlbHNlXG4gICAgICAgIHRoaXMuY29vcmRpbmF0ZU91dGVyQW5kVGVybWluYWwoY2hhbmdlKTtcbiAgICAgIHRoaXMuZ2V0TmV4dE9yV2FpdCgpO1xuICAgIH0pO1xuICAgIHRoaXMuZ2V0TmV4dE9yV2FpdCgpO1xuICB9XG4gIC8qKlxuICAgKiBzZXQgZGltZW5zaW9uc1xuICAgKi9cbiAgcHJpdmF0ZSBzZXRPdXRlckRpbWVuc2lvbnMobGVmdDogbnVtYmVyLCB0b3A6IG51bWJlciwgd2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXIpIHtcbiAgICB0aGlzLnJlcXVlc3RSZW5kZXJGcm9tQVBJLm5leHQoe1xuICAgICAgcm93Q2hhbmdlZDogZmFsc2UsIGNvbHVtbkNoYW5nZWQ6IGZhbHNlXG4gICAgICAsIGRyYWdnZWQ6IHsgZHJhZ2dlZFdpZHRoOiBgJHt3aWR0aH1weGAsIGRyYWdnZWRIZWlnaHQ6IGAke2hlaWdodH1weGAgfVxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbmRlciBpcyBiZWluZyB1c2VkIGZvciBmYXN0IHJlbmRlcmluZyB3aXRob3V0IG1hcmtGb3JDaGVjaygpLlxuICAgKi9cbiAgcHJpdmF0ZSBhcHBseVN0eWxlVG9EaXYoKSB7XG4gICAgT2JqZWN0LmtleXModGhpcy5zdHlsZXNGb3JEaXYpLm1hcChrZXkgPT4ge1xuICAgICAgcmV0dXJuIHsga2V5LCB2YWx1ZTogdGhpcy5zdHlsZXNGb3JEaXZba2V5XSB9XG4gICAgfSkuZm9yRWFjaCgoeyBrZXksIHZhbHVlIH0pID0+IHtcbiAgICAgIGlmICh2YWx1ZSlcbiAgICAgICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZSh0aGlzLnJlc2l6ZUJveC5uYXRpdmVFbGVtZW50LCBrZXksIHZhbHVlKTtcbiAgICAgIGVsc2Uge1xuICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbW92ZVN0eWxlKHRoaXMucmVzaXplQm94Lm5hdGl2ZUVsZW1lbnQsIGtleSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgdGhpcy5zdHlsZXNGb3JEaXYgPSB0aGlzLnN0eWxlc0ZvckRpdjsgLy9pbnZhbGlkYXRlXG4gIH1cblxuICAvKipcbiAgICogV2hlbiBkcmFnZ2FibGUgaXMgdHJ1ZSwgYWRkIGJvcmRlciBzdHlsZXMgXG4gICAqIFJlbmRlciBpcyBiZWluZyB1c2VkIGZvciBmYXN0IHJlbmRlcmluZyB3aXRob3V0IG1hcmtGb3JDaGVjaygpLlxuICAgKi9cbiAgLy8gcHJpdmF0ZSBhcHBseVN0eWxlVG9EcmFnZ2FibGUoKSB7XG4gIC8vICAgaWYgKHRoaXMuX2RyYWdnYWJsZUlucHV0KVxuICAvLyAgICAgdGhpcy5yZW5kZXJlci5hZGRDbGFzcyh0aGlzLnRlcm1pbmFsT3V0ZXIubmF0aXZlRWxlbWVudCwgJ2RyYWdnYWJsZScpO1xuICAvLyAgIGVsc2VcbiAgLy8gICAgIHRoaXMucmVuZGVyZXIucmVtb3ZlQ2xhc3ModGhpcy50ZXJtaW5hbE91dGVyLm5hdGl2ZUVsZW1lbnQsICdkcmFnZ2FibGUnKTtcbiAgLy8gfVxuXG4gIG5nT25Jbml0KCkge1xuICB9XG5cbiAgLyoqXG4gICAqIEl0IGNyZWF0ZXMgbmV3IHRlcm1pbmFsIGluICN0ZXJtaW5hbC5cbiAgICovXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpIHtcbiAgICB0aGlzLmZpdEFkZG9uID0gbmV3IEZpdEFkZG9uKCk7XG4gICAgdGhpcy50ZXJtID0gbmV3IFRlcm1pbmFsKCk7XG4gICAgdGhpcy50ZXJtLm9wZW4odGhpcy50ZXJtaW5hbE91dGVyLm5hdGl2ZUVsZW1lbnQpO1xuICAgIHRoaXMudGVybS5sb2FkQWRkb24odGhpcy5maXRBZGRvbik7XG4gICAgdGhpcy5vYnNlcnZhYmxlU2V0dXAoKTtcbiAgICB0aGlzLnJlcXVlc3RSZW5kZXJGcm9tQVBJLm5leHQoe30pO1xuICB9XG5cbiAgbmdPbkNoYW5nZXMoY2hhbmdlcz86IFNpbXBsZUNoYW5nZXMpIHtcbiAgICBjb25zb2xlLmdyb3VwKFwib25DaGFuZ2VzXCIpO1xuICAgIGNvbnNvbGUuZGVidWcoJ3Byb3A6ICcsIGNoYW5nZXMpO1xuICAgIGNvbnNvbGUuZ3JvdXBFbmQoKTtcbiAgICBpZiAoY2hhbmdlcz8uX3Jvd3NJbnB1dCkge1xuICAgICAgaWYgKGNoYW5nZXM/Ll9yb3dzSW5wdXQ/LnByZXZpb3VzVmFsdWUgIT0gY2hhbmdlcz8uX3Jvd3NJbnB1dD8uY3VycmVudFZhbHVlKSB7XG4gICAgICAgIHRoaXMucmVxdWVzdFJlbmRlckZyb21BUEkubmV4dCh7IHJvd0NoYW5nZWQ6IHRydWUgfSk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChjaGFuZ2VzPy5fY29sc0lucHV0KSB7XG4gICAgICBpZiAoY2hhbmdlcz8uX2NvbHNJbnB1dD8ucHJldmlvdXNWYWx1ZSAhPSBjaGFuZ2VzPy5fY29sc0lucHV0Py5jdXJyZW50VmFsdWUpIHtcbiAgICAgICAgdGhpcy5yZXF1ZXN0UmVuZGVyRnJvbUFQSS5uZXh0KHsgY29sdW1uQ2hhbmdlZDogdHJ1ZSB9KTtcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gdGhpcy5yZXF1ZXN0UmVuZGVyRnJvbUFQSS5uZXh0KHt9KTtcbiAgfVxuICAvKipcbiAgICogSXQgbXVzdCBiZSBjYWxsZWQgYWZ0ZXIgaGF2aW5nIGluaXRpYWxpemVkIHRoZSB0ZXJtaW5hbC5cbiAgICogeHRlcm0gZml0XG4gICAqIEBwYXJhbSByb3dDb2xDaGFuZ2UgXG4gICAqIEByZXR1cm5zIFxuICAgKi9cbiAgcHJpdmF0ZSBjb29yZGluYXRlT3V0ZXJBbmRUZXJtaW5hbChjaGFuZ2VMaXN0OiB7XG4gICAgcm93Q2hhbmdlZDogYm9vbGVhblxuICAgICwgY29sdW1uQ2hhbmdlZDogYm9vbGVhblxuICAgICwgZHJhZ2dlZD86IHsgZHJhZ2dlZFdpZHRoOiBzdHJpbmcsIGRyYWdnZWRIZWlnaHQ6IHN0cmluZyB9XG4gICAgLCBob3N0UmVzaXplZD86IHsgd2lkdGg6IHN0cmluZywgaGVpZ2h0OiBzdHJpbmcgfVxuICAgICwgd2hlblRlcm1pbmFsRGltZW5zaW9uSXNPdmVyT3V0ZXJEaXY/OiB7IHdpZHRoOiBzdHJpbmcsIGhlaWdodDogc3RyaW5nIH1cbiAgfSkge1xuICAgIGNvbnNvbGUuZGVidWcoYGNoYW5nZUxpc3Q6ICR7SlNPTi5zdHJpbmdpZnkoY2hhbmdlTGlzdCl9YCk7XG4gICAgLy8gYXBwbHkgYSBzdHlsZSBpbnB1dCB3aGlsZSBrZWVwaW5nIHdpZHRoIGFuZCBoZWlnaHQgZGVmYXVsdFxuICAgIHRoaXMuc3R5bGVzRm9yRGl2ID0ge1xuICAgICAgLi4udGhpcy5zdHlsZXNGb3JEaXZcbiAgICAgICwgLi4udGhpcy5fc3R5bGVzSW5wdXRcbiAgICAgICwgd2lkdGg6IHRoaXMuc3R5bGVzRm9yRGl2LndpZHRoXG4gICAgICAsIGhlaWdodDogdGhpcy5zdHlsZXNGb3JEaXYuaGVpZ2h0XG4gICAgfTtcbiAgICAvLyBidXQgaWYgdGhlIGRpdiBpcyBkcmFnZ2VkLCB1cGRhdGUgd2lkdGgsIGhlaWdodFxuICAgIGlmIChjaGFuZ2VMaXN0LmRyYWdnZWQpIHtcbiAgICAgIHRoaXMuc3R5bGVzRm9yRGl2LndpZHRoID0gY2hhbmdlTGlzdC5kcmFnZ2VkLmRyYWdnZWRXaWR0aDtcbiAgICAgIHRoaXMuc3R5bGVzRm9yRGl2LmhlaWdodCA9IGNoYW5nZUxpc3QuZHJhZ2dlZC5kcmFnZ2VkSGVpZ2h0O1xuICAgICAgdGhpcy5sYXN0RHJhZ2dlZFBvc2l0aW9uID0ge3dpZHRoOiBjaGFuZ2VMaXN0LmRyYWdnZWQuZHJhZ2dlZFdpZHRoLCBoZWlnaHQ6IGNoYW5nZUxpc3QuZHJhZ2dlZC5kcmFnZ2VkSGVpZ2h0fTtcbiAgICB9IGVsc2UgaWYgKCF0aGlzLl9yb3dzSW5wdXQgJiYgIXRoaXMuX2NvbHNJbnB1dCAmJiAhKHRoaXMuZHJhZ2dhYmxlICYmIHRoaXMubGFzdERyYWdnZWRQb3NpdGlvbikpIHtcbiAgICAgIC8vIGJ1dCBpZiB0aGUgZGltZW5zaW9uIG9mIGhvc3QgZWxlbWVudCBpcyByZXNpemVkLCB1cGRhdGUgd2lkdGggYW5kIGhlaWdodFxuICAgICAgdGhpcy5zdHlsZXNGb3JEaXYud2lkdGggPSAnMTAwJSc7XG4gICAgICB0aGlzLnN0eWxlc0ZvckRpdi5oZWlnaHQgPSAnMTAwJSc7XG4gICAgfVxuICAgIHRoaXMuYXBwbHlTdHlsZVRvRGl2KCk7XG5cbiAgICAvLyByZXNpemUgd2l0aCBuZXcgY29scyBhbmQgcm93cyBpZiB0aGV5IGNoYW5nZWQuXG4gICAgaWYgKGNoYW5nZUxpc3Qucm93Q2hhbmdlZCB8fCBjaGFuZ2VMaXN0LmNvbHVtbkNoYW5nZWQpIHtcbiAgICAgIHRoaXMudGVybS5yZXNpemUodGhpcy5fY29sc0lucHV0ID8/IHRoaXMudGVybS5jb2xzLCB0aGlzLl9yb3dzSW5wdXQgPz8gdGhpcy50ZXJtLnJvd3MpO1xuICAgIH0gZWxzZSB7IFxuICAgICAgLy8gZml0KCkgb3BlcmF0aW9uIGRvZXNuJ3Qgc2VlIHBhZGRpbmcgdmFsdWVzIG9mIHRlcm1pbmFsT3V0ZXIuXG4gICAgICAvLyBCdXQgaXQgdXNlcyBwYWRkaW5nIHZhbHVlcyBvZiB0ZXJtaW5hbCBlbGVtZW50LlxuICAgICAgLy8gU28gd2UgZm9yY2UgdG8gc2V0IHBhZGRpbmcgdmFsdWVzIHdoZW4gY2FsbGluZyBmaXQoKSBvcGVyYXRpb24gZm9yIGEgd2hpbGUuXG4gICAgICB0aGlzLnRlcm0uZWxlbWVudC5zdHlsZS5wYWRkaW5nTGVmdCA9IGAke3RoaXMucGFkZGluZ1NpemV9cHhgO1xuICAgICAgdGhpcy50ZXJtLmVsZW1lbnQuc3R5bGUucGFkZGluZ1JpZ2h0ID0gYCR7dGhpcy5wYWRkaW5nU2l6ZX1weGA7XG4gICAgICB0aGlzLmZpdEFkZG9uLmZpdCgpO1xuICAgICAgdGhpcy50ZXJtLmVsZW1lbnQuc3R5bGUucGFkZGluZyA9ICcwcHgnO1xuICAgIH1cblxuICAgIC8vIGNvb3JkaW5hdGUgZGlmZmVyZW5jZSBiZXR3ZWVuIHRlcm1pbmFsIGFuZCBvdXRlclxuICAgIGxldCB4dGVybVNjcmVlbiA9IHRoaXMudGVybS5lbGVtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ3h0ZXJtLXNjcmVlbicpWzBdO1xuICAgIGxldCB4dGVybVZpZXdwb3J0ID0gdGhpcy50ZXJtLmVsZW1lbnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgneHRlcm0tdmlld3BvcnQnKVswXTtcbiAgICBjb25zdCB0ZXJtaW5hbFdpZHRoID0geHRlcm1TY3JlZW4uY2xpZW50V2lkdGg7XG4gICAgY29uc3QgdGVybWluYWxIZWlnaHQgPSB4dGVybVNjcmVlbi5jbGllbnRIZWlnaHQ7XG4gICAgY29uc3QgY29yZSA9ICh0aGlzLnVuZGVybHlpbmcgYXMgYW55KS5fY29yZTtcbiAgICBjb25zdCBzY3JvbGxXaWR0aDogbnVtYmVyID0gY29yZS52aWV3cG9ydC5zY3JvbGxCYXJXaWR0aCBhcyBudW1iZXI7XG4gICAgIFxuICAgIC8vIEl0IGZpeGVzIHRoYXQgdGhlIHZpZXdwb3J0J3Mgd2lkdGggZG9lc24ndCBjaGFuZ2VzIGFmdGVyIGNhbGxpbmcgZml0KClcbiAgICB0aGlzLnJlbmRlcmVyLnNldFN0eWxlKHh0ZXJtVmlld3BvcnQsICd3aWR0aCcsIGAke3Rlcm1pbmFsV2lkdGggKyBzY3JvbGxXaWR0aH1weGApO1xuICAgIGNvbnNvbGUuZGVidWcodGVybWluYWxXaWR0aCArIHNjcm9sbFdpZHRoICsgdGhpcy5wYWRkaW5nU2l6ZSoyICwgdGVybWluYWxXaWR0aCwgc2Nyb2xsV2lkdGgsIHRoaXMucGFkZGluZ1NpemUqMiApOyAvLyArIGJvcmRlcldpZHRoICogMlxuICAgIGNvbnNvbGUuZGVidWcodGVybWluYWxIZWlnaHQgKyB0aGlzLnBhZGRpbmdTaXplKjIgLCB0ZXJtaW5hbEhlaWdodCk7XG4gICAgdGhpcy5zdHlsZXNGb3JEaXYgPSB7XG4gICAgICAuLi50aGlzLnN0eWxlc0ZvckRpdiwgd2lkdGg6IGAke3Rlcm1pbmFsV2lkdGggKyBzY3JvbGxXaWR0aCArdGhpcy5wYWRkaW5nU2l6ZSoyIH1weGBcbiAgICAgICwgaGVpZ2h0OiBgJHt0ZXJtaW5hbEhlaWdodCArIHRoaXMucGFkZGluZ1NpemUqMiB9cHhgXG4gICAgfTtcbiAgICB0aGlzLmFwcGx5U3R5bGVUb0RpdigpO1xuICAgIHRoaXMucmVmLm1hcmtGb3JDaGVjaygpO1xuICB9XG5cbiAgb2JzZXJ2ZVRlcm1pbmFsRGltZW5zaW9uKCkge1xuICAgIGxldCB2aWV3cG9ydDogSFRNTERpdkVsZW1lbnQgfCB1bmRlZmluZWQgPSB0aGlzLnRlcm1pbmFsT3V0ZXIubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yKCcueHRlcm0tdmlld3BvcnQnKTtcbiAgICBpZiAodmlld3BvcnQpIHtcbiAgICAgIGNvbnN0IHJlc2l6ZU9ic2VydmVyID0gbmV3IFJlc2l6ZU9ic2VydmVyKGVudHJpZXMgPT4ge1xuICAgICAgICBjb25zdCBkaXZXaWR0aCA9IHBhcnNlRmxvYXQoZ2V0Q29tcHV0ZWRTdHlsZSh0aGlzLnRlcm1pbmFsT3V0ZXIubmF0aXZlRWxlbWVudCkud2lkdGgpO1xuICAgICAgICBjb25zdCBkaXZIZWlnaHQgPSBwYXJzZUZsb2F0KGdldENvbXB1dGVkU3R5bGUodGhpcy50ZXJtaW5hbE91dGVyLm5hdGl2ZUVsZW1lbnQpLmhlaWdodCk7XG4gICAgICAgIGxldCB3aWR0aDogbnVtYmVyID0gdW5kZWZpbmVkO1xuICAgICAgICBsZXQgaGVpZ2h0OiBudW1iZXIgPSB1bmRlZmluZWQ7XG4gICAgICAgIGZvciAobGV0IGVudHJ5IG9mIGVudHJpZXMpIHtcbiAgICAgICAgICBpZiAoZW50cnkuY29udGVudEJveFNpemUpIHtcbiAgICAgICAgICAgIGlmIChlbnRyeS50YXJnZXQgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkge1xuICAgICAgICAgICAgICB3aWR0aCA9IHBhcnNlRmxvYXQoZ2V0Q29tcHV0ZWRTdHlsZShlbnRyeS50YXJnZXQpLndpZHRoKTtcbiAgICAgICAgICAgICAgaGVpZ2h0ID0gcGFyc2VGbG9hdChnZXRDb21wdXRlZFN0eWxlKGVudHJ5LnRhcmdldCkuaGVpZ2h0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgd2lkdGggPSBwYXJzZUZsb2F0KGdldENvbXB1dGVkU3R5bGUoZW50cnkudGFyZ2V0KS53aWR0aCk7XG4gICAgICAgICAgICBoZWlnaHQgPSBwYXJzZUZsb2F0KGdldENvbXB1dGVkU3R5bGUoZW50cnkudGFyZ2V0KS5oZWlnaHQpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAod2lkdGggPiBkaXZXaWR0aCB8fCBoZWlnaHQgPiBkaXZIZWlnaHQpIHtcbiAgICAgICAgICB0aGlzLnJlcXVlc3RSZW5kZXJGcm9tQVBJLm5leHQoeyB3aGVuVGVybWluYWxEaW1lbnNpb25Jc092ZXJPdXRlckRpdjogeyB3aWR0aDogYCR7d2lkdGh9cHhgLCBoZWlnaHQ6IGAke2hlaWdodH1weGAgfSB9KTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICByZXNpemVPYnNlcnZlci5vYnNlcnZlKHZpZXdwb3J0KTtcbiAgICAgIHJldHVybiByZXNpemVPYnNlcnZlcjtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc29sZS5lcnJvcihcIkludmFsaWQgc3RhdGUgaXMgZGV0ZWN0ZWQuIHh0ZXJtIGVsZW1lbnQgc2hvdWxkIGV4aXN0IGJlbG93IC50ZXJtaW5hbC1vdXRlci5cIilcbiAgICB9XG4gIH1cblxuICBvYnNlcnZlSG9zdERpbWVuc2lvbigpIHtcbiAgICBsZXQgaG9zdEVsZW1lbnQ6IEhUTUxEaXZFbGVtZW50IHwgdW5kZWZpbmVkID0gdGhpcy5ob3N0UmVmLm5hdGl2ZUVsZW1lbnQ7XG4gICAgaWYgKGhvc3RFbGVtZW50KSB7XG4gICAgICBjb25zdCByZXNpemVPYnNlcnZlciA9IG5ldyBSZXNpemVPYnNlcnZlcihlbnRyaWVzID0+IHtcbiAgICAgICAgbGV0IHdpZHRoOiBudW1iZXIgPSB1bmRlZmluZWQ7XG4gICAgICAgIGxldCBoZWlnaHQ6IG51bWJlciA9IHVuZGVmaW5lZDtcbiAgICAgICAgZm9yIChsZXQgZW50cnkgb2YgZW50cmllcykge1xuICAgICAgICAgIGlmIChlbnRyeS5jb250ZW50Qm94U2l6ZSkge1xuICAgICAgICAgICAgaWYgKGVudHJ5LnRhcmdldCBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KSB7XG4gICAgICAgICAgICAgIHdpZHRoID0gcGFyc2VGbG9hdChnZXRDb21wdXRlZFN0eWxlKGVudHJ5LnRhcmdldCkud2lkdGgpO1xuICAgICAgICAgICAgICBoZWlnaHQgPSBwYXJzZUZsb2F0KGdldENvbXB1dGVkU3R5bGUoZW50cnkudGFyZ2V0KS5oZWlnaHQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB3aWR0aCA9IHBhcnNlRmxvYXQoZ2V0Q29tcHV0ZWRTdHlsZShlbnRyeS50YXJnZXQpLndpZHRoKTtcbiAgICAgICAgICAgIGhlaWdodCA9IHBhcnNlRmxvYXQoZ2V0Q29tcHV0ZWRTdHlsZShlbnRyeS50YXJnZXQpLmhlaWdodCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRoaXMucmVxdWVzdFJlbmRlckZyb21BUEkubmV4dCh7IGhvc3RSZXNpemVkOiB7IHdpZHRoOiBgJHt3aWR0aH1weGAsIGhlaWdodDogYCR7aGVpZ2h0fXB4YCB9IH0pO1xuICAgICAgfSk7XG4gICAgICByZXNpemVPYnNlcnZlci5vYnNlcnZlKGhvc3RFbGVtZW50KTtcbiAgICAgIHJldHVybiByZXNpemVPYnNlcnZlcjtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc29sZS5lcnJvcihcIkludmFsaWQgc3RhdGUgaXMgZGV0ZWN0ZWQuIHh0ZXJtIGVsZW1lbnQgc2hvdWxkIGV4aXN0IGJlbG93IC50ZXJtaW5hbC1vdXRlci5cIilcbiAgICB9XG4gIH1cbiAgLyoqXG4gICAqIGNsZWFuIGFsbCByZXNvdXJjZXNcbiAgICovXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmtleUlucHV0U3ViamVjdFN1YnNjcmlwdGlvbilcbiAgICAgIHRoaXMua2V5SW5wdXRTdWJqZWN0U3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgaWYgKHRoaXMuZGF0YVNvdXJjZVN1YnNjcmlwdGlvbilcbiAgICAgIHRoaXMuZGF0YVNvdXJjZVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIGlmICh0aGlzLmtleUV2ZW50U3ViamVjdFN1YnNjcmlwdGlvbilcbiAgICAgIHRoaXMua2V5RXZlbnRTdWJqZWN0U3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgaWYgKHRoaXMucmVxdWVzdFJlbmRlclN1YnNjcmlwdGlvbilcbiAgICAgIHRoaXMucmVxdWVzdFJlbmRlclN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIGlmICh0aGlzLmFsbExvZ3NTdWJqZWN0U3Vic2NyaXB0aW9uKVxuICAgICAgdGhpcy5hbGxMb2dzU3ViamVjdFN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIGlmICh0aGlzLmludGVydmFsKVxuICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLmludGVydmFsKTtcbiAgICBpZiAodGhpcy50ZXJtKVxuICAgICAgdGhpcy50ZXJtLmRpc3Bvc2UoKTtcbiAgICB0aGlzLnJlc2l6YWJsZU9ic2VydmVycy5mb3JFYWNoKG9iID0+IG9iLmRpc2Nvbm5lY3QoKSk7XG4gIH1cblxuICB3cml0ZShjaGFyczogc3RyaW5nKSB7XG4gICAgdGhpcy50ZXJtLndyaXRlKGNoYXJzKTtcbiAgfVxuXG4gIGdldCBrZXlJbnB1dCgpOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xuICAgIHJldHVybiB0aGlzLmtleUlucHV0U3ViamVjdDtcbiAgfVxuXG4gIGdldCBrZXlFdmVudElucHV0KCk6IE9ic2VydmFibGU8eyBrZXk6IHN0cmluZzsgZG9tRXZlbnQ6IEtleWJvYXJkRXZlbnQ7IH0+IHtcbiAgICByZXR1cm4gdGhpcy5rZXlFdmVudFN1YmplY3Q7XG4gIH1cblxuICBnZXQgdW5kZXJseWluZygpOiBUZXJtaW5hbCB7XG4gICAgcmV0dXJuIHRoaXMudGVybTtcbiAgfVxuXG4gIGdldCBpc0RyYWdnYWJsZU9uRWRnZUFjdGl2YXRlZCgpIHtcbiAgICAvLyByZXR1cm4gdGhpcy5kaXNwbGF5T3B0aW9uLmFjdGl2YXRlRHJhZ2dhYmxlT25FZGdlICE9IHVuZGVmaW5lZCAmJiB0aGlzLmRpc3BsYXlPcHRpb24uZml4ZWRHcmlkID09IHVuZGVmaW5lZDtcbiAgICByZXR1cm4gdGhpcy5fZHJhZ2dhYmxlSW5wdXQ7XG4gIH1cblxuICAvKipcbiAgICogQWZ0ZXIgdXNlciBjb29yZGluYXRlIGRpbWVuc2lvbnMgb2YgdGVybWluYWwsIGl0J3MgY2FsbGVkLlxuICAgKiBAcGFyYW0gbGVmdCBcbiAgICogQHBhcmFtIHRvcCBcbiAgICogQHBhcmFtIHdpZHRoIFxuICAgKiBAcGFyYW0gaGVpZ2h0IFxuICAgKi9cbiAgb25SZXNpemVFbmQobGVmdDogbnVtYmVyLCB0b3A6IG51bWJlciwgd2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXIpOiB2b2lkIHtcbiAgICB0aGlzLnNldE91dGVyRGltZW5zaW9ucyhsZWZ0LCB0b3AsIHdpZHRoLCBoZWlnaHQpO1xuICB9XG5cbiAgLyoqXG4gICAqIEJlZm9yZSBvblJlc2l6ZUVuZCBpcyBjYWxsZWQsIGl0IHZhbGlhdGVzIGRpbWVuc2lvbnMgdG8gY2hhbmdlLlxuICAgKiBAcGFyYW0gcmUgZGltZW5zaW9uIHRvIGJlIHN1Ym1pdHRlZCBmcm9tIHJlc2l6YWJsZSBzdHVmZlxuICAgKi9cbiAgdmFsaWRhdG9yRmFjdG9yeSgpOiAocmU6IFJlc2l6ZUV2ZW50KSA9PiBib29sZWFuIHtcbiAgICBjb25zdCBjb21wID0gdGhpcztcbiAgICByZXR1cm4gKHJlOiBSZXNpemVFdmVudCkgPT4ge1xuICAgICAgLy8gY29uc3QgZGlzcGxheU9wdGlvbiA9IGNvbXAuZGlzcGxheU9wdGlvbjtcbiAgICAgIGlmICh0aGlzLl9kcmFnZ2FibGVJbnB1dCkge1xuICAgICAgICBsZXQgbGVmdCA9IHJlLnJlY3RhbmdsZS5sZWZ0LCB0b3AgPSByZS5yZWN0YW5nbGUudG9wLCB3aWR0aCA9IHJlLnJlY3RhbmdsZS53aWR0aCwgaGVpZ2h0ID0gcmUucmVjdGFuZ2xlLmhlaWdodDtcbiAgICAgICAgaWYgKCh3aWR0aCA8ICh0aGlzLl9taW5XaWR0aElucHV0ID8/IDEwMCkpIHx8IChoZWlnaHQgPCAodGhpcy5fbWluSGVpZ2h0SW5wdXQgPz8gNTApKSkge1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfSBlbHNlIHJldHVybiB0cnVlO1xuICAgICAgfSBlbHNlXG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH1cblxufVxuIiwiPGdsb2JhbC1zdHlsZT48L2dsb2JhbC1zdHlsZT5cbjxkaXYgbXdsUmVzaXphYmxlICNyZXNpemVCb3ggY2xhc3M9XCJyZXNpemUtYm94XCIgW3ZhbGlkYXRlUmVzaXplXT1cInZhbGlkYXRvckZhY3RvcnkoKVwiIFtlbmFibGVHaG9zdFJlc2l6ZV09XCJ0cnVlXCJcbiAgICAocmVzaXplRW5kKT1cIm9uUmVzaXplRW5kKCRldmVudC5yZWN0YW5nbGUubGVmdCwgJGV2ZW50LnJlY3RhbmdsZS50b3AsICRldmVudC5yZWN0YW5nbGUud2lkdGgsICRldmVudC5yZWN0YW5nbGUuaGVpZ2h0KVwiPlxuICAgIDxkaXYgI3Rlcm1pbmFsIGNsYXNzPVwidGVybWluYWwtb3V0ZXJcIj5cbiAgICA8L2Rpdj5cbiAgICA8ZGl2IGNsYXNzPVwicmVzaXplLWhhbmRsZSByZXNpemUtaGFuZGxlLXRvcFwiIG13bFJlc2l6ZUhhbmRsZSBbbmdDbGFzc109XCJ7J2hhbmRsZS1hY3RpdmUnIDogaXNEcmFnZ2FibGVPbkVkZ2VBY3RpdmF0ZWR9XCJcbiAgICAgICAgW3Jlc2l6ZUVkZ2VzXT1cInsgdG9wOiBmYWxzZSB9XCI+PC9kaXY+XG4gICAgPGRpdiBjbGFzcz1cInJlc2l6ZS1oYW5kbGUgcmVzaXplLWhhbmRsZS1sZWZ0XCIgbXdsUmVzaXplSGFuZGxlIFtuZ0NsYXNzXT1cInsnaGFuZGxlLWFjdGl2ZScgOiBpc0RyYWdnYWJsZU9uRWRnZUFjdGl2YXRlZH1cIlxuICAgICAgICBbcmVzaXplRWRnZXNdPVwieyBsZWZ0OiBmYWxzZSB9XCI+PC9kaXY+XG4gICAgPGRpdiBjbGFzcz1cInJlc2l6ZS1oYW5kbGUgcmVzaXplLWhhbmRsZS1yaWdodFwiIG13bFJlc2l6ZUhhbmRsZSBbbmdDbGFzc109XCJ7J2hhbmRsZS1hY3RpdmUnIDogaXNEcmFnZ2FibGVPbkVkZ2VBY3RpdmF0ZWR9XCJcbiAgICAgICAgW3Jlc2l6ZUVkZ2VzXT1cImlzRHJhZ2dhYmxlT25FZGdlQWN0aXZhdGVkID8geyByaWdodDogdHJ1ZSB9IDogeyByaWdodDogZmFsc2UgfVwiPjwvZGl2PlxuICAgIDxkaXYgY2xhc3M9XCJyZXNpemUtaGFuZGxlIHJlc2l6ZS1oYW5kbGUtYm90dG9tXCIgbXdsUmVzaXplSGFuZGxlIFtuZ0NsYXNzXT1cInsnaGFuZGxlLWFjdGl2ZScgOiBpc0RyYWdnYWJsZU9uRWRnZUFjdGl2YXRlZH1cIlxuICAgICAgICBbcmVzaXplRWRnZXNdPVwiaXNEcmFnZ2FibGVPbkVkZ2VBY3RpdmF0ZWQgPyB7IGJvdHRvbTogdHJ1ZSB9IDogeyBib3R0b206IGZhbHNlIH1cIj48L2Rpdj5cbjwvZGl2PiJdfQ==